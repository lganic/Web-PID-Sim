<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PID Simulator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0b0e13;
      --panel: #131722;
      --ink: #e6eefc;
      --muted: #9db1d4;
      --accent: #4cc9f0;
      --ok: #4caf50;
      --warn: #ff6d00;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--ink)
    }

    header {
      padding: 16px 20px;
      border-bottom: 1px solid #1e2433;
      background: linear-gradient(180deg, #0e1420, #0b0e13)
    }

    header h1 {
      margin: 0;
      font-size: 15px;
      letter-spacing: .2px
    }

    .wrap {
      display: grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 16px;
      padding: 16px;
      max-width: 1400px;
      margin: 0 auto
    }

    .card {
      background: var(--panel);
      border: 1px solid #212a3d;
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 4px 18px rgba(0, 0, 0, .25)
    }

    .card h2 {
      margin: 0 0 10px 0;
      font-size: 15px;
      color: var(--muted);
      font-weight: 600
    }

    #scene {
      width: 100%;
      height: 180px;
      display: block;
      /* background: linear-gradient(180deg, #0e1726 0%, #0e1726 60%, #0b0e13 60%); */
      background: #0e1726;
      border-radius: 10px;
      border: 1px solid #223046
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px
    }

    .control {
      background: #0f1420;
      border: 1px solid #24324a;
      border-radius: 10px;
      padding: 10px
    }

    .control label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px
    }

    .control input[type="range"] {
      width: 100%
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .row>* {
      flex: 1
    }

    .kv {
      font-variant-numeric: tabular-nums;
      color: var(--ink)
    }

    .btns {
      display: flex;
      gap: 8px;
      margin-top: 8px
    }

    button {
      background: #1a2334;
      color: var(--ink);
      border: 1px solid #28324a;
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer
    }

    button:hover {
      border-color: #3a4b71
    }

    .charts {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px
    }

    canvas.chart {
      background: #0f1420;
      border: 1px solid #223046;
      border-radius: 10px;
      width: 100%;
      height: 220px
    }

    .legend {
      font-size: 12px;
      color: var(--muted)
    }

    .inline {
      display: inline-flex;
      gap: 12px;
      align-items: center
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
    }

    .modal-content {
      background: #131b2b;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #223046;
      border-radius: 10px;
      width: 60%;
      max-height: 80%;
      overflow-y: auto;
      color: #fff;
    }

    .modal-content h2 {
      margin-top: 0;
    }

    .close {
      float: right;
      font-size: 20px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <header>
    <h1>PID Simulator</h1>
  </header>
  <div style="text-align: center !important;">
    <br>
    <a href="https://github.com/lganic/Web-PID-Sim/" target="_blank">
      <img src="https://img.shields.io/badge/Source Code Here-blue?style=social&logo=github" alt="GitHub link"
        style="width: 300px; height: auto;">
    </a>
  </div>
  <div class="wrap">
    <section class="card">
      <h2>Scene</h2>
      <canvas id="scene" width="1200" height="180"></canvas>
      <input type="range" id="zoomSlider" min="0.5" max="5" step="0.1" value="1">
      <div class="row" style="margin-top:10px">
        <div class="legend">Red = Target boat · Green = Current boat</div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>δ (error): <span class="kv" id="deltaReadout">0.00</span></div>
        <div>pos: <span class="kv" id="posReadout">0.00</span></div>
        <div>target: <span class="kv" id="tgtReadout">0.00</span></div>
      </div>
    </section>

    <aside class="card">
      <h2>Controls</h2>
      <div class="controls">
        <div class="control">
          <label>Proportional (P) <span class="kv" id="Pval">15.00</span></label>
          <input id="P" type="range" min="0" max="100" step="0.1" value="15">
        </div>
        <div class="control">
          <label>Wind / Static Force <span class="kv" id="Wval">-100.00</span></label>
          <input id="W" type="range" min="-300" max="300" step="1" value="-100">
        </div>
        <div class="control">
          <label>Integral (I) <span class="kv" id="Ival">1.00</span></label>
          <input id="I" type="range" min="0" max="10" step="0.01" value="1">
        </div>
        <div class="control">
          <label>Target amplitude <span class="kv" id="Aval">80</span></label>
          <input id="A" type="range" min="0" max="150" step="1" value="80">
        </div>
        <div class="control">
          <label>Derivative (D) <span class="kv" id="Dval">300.00</span></label>
          <input id="D" type="range" min="0" max="1000" step="1" value="300">
        </div>
        <div class="control">
          <label>Target period (s) <span class="kv" id="Tval">10</span></label>
          <input id="T" type="range" min="2" max="30" step="0.5" value="10">
        </div>
      </div>
      <div class="btns">
        <button id="reset">Reset</button>
        <button id="pause">Pause</button>
        <button id="helpBtn">Help</button>
      </div>
    </aside>

    <section class="card" style="grid-column:1 / -1">
      <div class="charts">
        <canvas id="deltaChart" class="chart" width="100%" height="15vh"></canvas>
        <canvas id="posChart" class="chart" width="100%" height="15vh"></canvas>
      </div>
    </section>
  </div>

  <div id="helpModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeHelp">&times;</span>
      <h2>Help — PID Boat Simulator</h2>
      <p>This simulator demonstrates a PID controller attempting to track a moving target position (red boat) with a
        controlled system (green boat). The target follows a sine wave motion.</p>
      <ul>
        <li><b>Scene:</b> Shows target (red) and current (green) boats on water (blue line).</li>
        <li><b>P, I, D Sliders:</b> Adjust proportional, integral, and derivative gains of the controller.</li>
        <li><b>Wind:</b> Adds a constant force offset to the system.</li>
        <li><b>Zoom Slider:</b> On the right side of the scene, zoom in/out vertically.</li>
        <li><b>Charts:</b> Delta (error between target and current) and Position (target vs. current) over time. </li>
      </ul>
      <p>Experiment with the PID parameters to see how the system reacts! Try increasing P for faster response, D for
        damping, or I to correct steady-state error. Be careful: too high gains can cause instability.</p>
    </div>
  </div>

  <script>
    // --- Simulation params ---
    let P = 15, I = 1, D = 300;
    let STATIC_FORCE = -100;
    const FPS = 60; // simulation framerate target
    const renderDt = 1 / FPS;
    const world = { xMin: -100, xMax: 100, yMin: -5, yMax: 25 };

    // Target: A * sin(2π t / T)
    let A = 80; // amplitude
    let T = 10; // period seconds

    // Random start phase/time like Python code
    const randomStartTime = 15000 * Math.random();

    function expectedFunction(t) {
      return A * Math.sin(2 * Math.PI * t / T);
    }

    class State {
      constructor(delta_t, starting_position = 0) {
        this.delta_t = delta_t;
        this.position = starting_position;
        this.velocity = 0;
      }
      update(acceleration) {
        // midpoint method
        this.velocity += acceleration * this.delta_t / 2;
        this.position += this.velocity * this.delta_t;
        this.velocity += acceleration * this.delta_t / 2;
      }
    }

    // --- Canvas / Frame like utilities ---
    const scene = document.getElementById('scene');
    const ctx = scene.getContext('2d');

    function resizeCanvasForDPR(canvas) {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);
      const c = canvas.getContext('2d');
      c.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    const ro = new ResizeObserver(() => resizeCanvasForDPR(scene));
    ro.observe(scene);

    // World→Screen transform
    function w2s(x, y) {

      x /= zoomFactor;
      y /= zoomFactor;

      const rect = scene.getBoundingClientRect();
      const W = rect.width, H = rect.height;
      const sx = (x - world.xMin) / (world.xMax - world.xMin) * W;
      const sy = H - (y - world.yMin) / (world.yMax - world.yMin) * H;
      return [sx, sy];
    }

    function drawPath(points, strokeStyle, fill = false) {
      if (points.length === 0) return;
      ctx.beginPath();
      const [x0, y0] = w2s(points[0][0], points[0][1]);
      ctx.moveTo(x0, y0);
      for (let i = 1; i < points.length; i++) {
        const [x, y] = w2s(points[i][0], points[i][1]);
        ctx.lineTo(x, y);
      }
      ctx.strokeStyle = strokeStyle;
      ctx.lineWidth = 2;
      ctx.stroke();
      if (fill) {
        ctx.fillStyle = strokeStyle;
        ctx.globalAlpha = 0.08;
        ctx.fill();
        ctx.globalAlpha = 1;
      }
    }

    function drawBoat(x, y, size = 15, color = 'lime') {
      const pts = [
        [x, y],
        [x + size, y],
        [x + .8 * size, y - .2 * size],
        [x - .8 * size, y - .2 * size],
        [x - size, y],
        [x, y],
        [x, y + size],
        [x + .6 * size, y + .6 * size],
        [x, y + .4 * size],
      ];
      drawPath(pts, color, false);
    }

    let zoomFactor = 1;
    document.getElementById('zoomSlider').addEventListener('input', e => {
      zoomFactor = parseFloat(e.target.value);
    });

    function clearScene() {
      const r = scene.getBoundingClientRect();
      ctx.clearRect(0, 0, r.width, r.height);
      // horizon/water line at y=-3
      drawPath([[-1000, -3], [1000, -3]], '#4da3ff', false);
    }

    // --- Charts (Chart.js) ---
    const timeWindow = 10; // seconds visible
    const deltaCtx = document.getElementById('deltaChart').getContext('2d');
    const posCtx = document.getElementById('posChart').getContext('2d');

    const deltaChart = new Chart(deltaCtx, {
      type: 'line',
      data: {
        labels: [], datasets: [{
          label: 'Delta', data: [], tension: 0.15, borderWidth: 2
        }]
      },
      options: {
        animation: false,
        responsive: true,
        maintainAspectRatio: true,
        scales: { x: { type: 'linear', title: { display: true, text: 'Time (s)' } }, y: { min: -120, max: 120, title: { display: true, text: 'Delta' } } },
        plugins: { legend: { display: false } }
      }
    });

    const posChart = new Chart(posCtx, {
      type: 'line',
      data: {
        labels: [], datasets: [
          { label: 'Target', data: [], borderWidth: 2 },
          { label: 'Current', data: [], borderWidth: 2 }
        ]
      },
      options: {
        animation: false,
        responsive: true,
        maintainAspectRatio: true,
        scales: { x: { type: 'linear', title: { display: true, text: 'Time (s)' } }, y: { min: -120, max: 120, title: { display: true, text: 'Position' } } }
      }
    });

    // --- Simulation loop ---
    let running = true;
    let frameIndex = 0;
    let currentState = new State(renderDt);
    let runningTotalError = 0;
    let lastDelta = null;

    // Pre-roll 3 seconds render like Python (visual warmup)
    let warmupStart = performance.now();

    function reset() {
      frameIndex = 0;
      currentState = new State(renderDt);
      runningTotalError = 0;
      lastDelta = null;
      deltaChart.data.datasets[0].data = [];
      posChart.data.datasets[0].data = [];
      posChart.data.datasets[1].data = [];
      deltaChart.update(); posChart.update();
    }

    function loop(now) {
      if (!running) { requestAnimationFrame(loop); return; }

      const t = frameIndex * renderDt; // seconds
      frameIndex++;

      clearScene();

      // target & current positions
      const targetPos = expectedFunction(t + randomStartTime);
      drawBoat(targetPos, 0, 15, 'red');
      drawBoat(currentState.position, 0, 15, 'lime');

      // PID
      const delta = targetPos - currentState.position;
      runningTotalError += delta;
      if (lastDelta === null) lastDelta = delta;

      let output = P * delta;
      output += (delta - lastDelta) * D;
      output += runningTotalError * I;
      lastDelta = delta;

      if (I == 0) {
        runningTotalError = 0; // Special case in case the integral was set to zero, and there is a consistent steady state error. This keeps the integral term from going crazy when the integral term is re-added.
      }

      currentState.update(output + STATIC_FORCE);

      const startCut = Math.max(0, t - timeWindow);
      // Delta
      deltaChart.data.datasets[0].data.push({ x: t, y: delta });
      deltaChart.data.datasets[0].data = deltaChart.data.datasets[0].data.filter(p => p.x >= startCut);
      deltaChart.options.scales.x.min = startCut;
      deltaChart.options.scales.x.max = t;
      deltaChart.update();
      // Position
      posChart.data.datasets[0].data.push({ x: t, y: targetPos });
      posChart.data.datasets[1].data.push({ x: t, y: currentState.position });
      posChart.data.datasets[0].data = posChart.data.datasets[0].data.filter(p => p.x >= startCut);
      posChart.data.datasets[1].data = posChart.data.datasets[1].data.filter(p => p.x >= startCut);
      posChart.options.scales.x.min = startCut;
      posChart.options.scales.x.max = t;
      posChart.update();

      function fitAxis(chart) {
        let all = [];
        chart.data.datasets.forEach(ds => { all = all.concat(ds.data.map(p => p.y)); });

        if (all.length === 0) return;

        let min = Math.min(...all), max = Math.max(...all);

        max = Math.max(1, max);
        min = Math.min(-1, min);

        // Ensure correct signs. This step is kind redundant, but its more of a sanity check for me. 
        max = Math.abs(max);
        min = -Math.abs(min);

        if (max > -min) {
          min = - max;
        }

        if (-min > max) {
          max = -min;
        }

        chart.options.scales.y = { min: min, max: max };
      }
      fitAxis(deltaChart);
      fitAxis(posChart);

      // Readouts
      document.getElementById('deltaReadout').textContent = delta.toFixed(2);
      document.getElementById('posReadout').textContent = currentState.position.toFixed(2);
      document.getElementById('tgtReadout').textContent = targetPos.toFixed(2);

      requestAnimationFrame(loop);
    }

    // Warmup render (~3s) similar to matplotlib pre-loop
    function warmup() {
      const t = (performance.now() - warmupStart) / 1000;
      clearScene();
      const pos = expectedFunction(randomStartTime);
      drawBoat(pos, 0, 15, 'red');
      drawBoat(currentState.position, 0, 15, 'lime');
      if (t < 1) { requestAnimationFrame(warmup); }
      else { requestAnimationFrame(loop); }
    }

    // Controls wiring
    const Pslider = document.getElementById('P');
    const Islider = document.getElementById('I');
    const Dslider = document.getElementById('D');
    const Wslider = document.getElementById('W');
    const Aslider = document.getElementById('A');
    const Tslider = document.getElementById('T');

    function bind(slider, setter, readoutId) {
      const out = document.getElementById(readoutId);
      const upd = () => { setter(parseFloat(slider.value)); out.textContent = parseFloat(slider.value).toFixed(2); };
      slider.addEventListener('input', upd);
      upd();
    }

    bind(Pslider, v => P = v, 'Pval');
    bind(Islider, v => I = v, 'Ival');
    bind(Dslider, v => D = v, 'Dval');
    bind(Wslider, v => STATIC_FORCE = v, 'Wval');

    // amplitude & period have integer readouts
    const Aval = document.getElementById('Aval');
    const Tval = document.getElementById('Tval');
    Aslider.addEventListener('input', () => { A = parseFloat(Aslider.value); Aval.textContent = Aslider.value; });
    Tslider.addEventListener('input', () => { T = parseFloat(Tslider.value); Tval.textContent = Tslider.value; });

    document.getElementById('reset').addEventListener('click', reset);
    document.getElementById('pause').addEventListener('click', () => {
      running = !running;
      document.getElementById('pause').textContent = running ? 'Pause' : 'Resume';
      if (running) requestAnimationFrame(loop);
    });

    // Kickoff
    resizeCanvasForDPR(scene);
    warmup();

    // Modal logic
    const helpModal = document.getElementById('helpModal');
    document.getElementById('helpBtn').onclick = () => { helpModal.style.display = 'block'; };
    document.getElementById('closeHelp').onclick = () => { helpModal.style.display = 'none'; };
    window.onclick = (e) => { if (e.target === helpModal) helpModal.style.display = 'none'; };
  </script>
</body>

</html>